% -*-cap2.tex-*-
% Este fichero es parte de la plantilla LaTeX para
% la realización de Proyectos Final de Carrera, protejido
% bajo los términos de la licencia GFDL.
% Para más información, la licencia completa viene incluida en el
% fichero fdl-1.3.tex

% Copyright (C) 2009 Pablo Recio Quijano 

En este capítulo vamos a describir y explicar los detalles de la implementación del sistema software y de la solución propuesta.

\section{Solución propuesta}

Debido a los objetivos y requisitos definidos en las anteriores secciones del documento, ya desde un primer momento se antojaba necesario realizar la implementación de una aplicación móvil, por lo que disponíamos de dos opciones a considerar: hacer una aplicación Android o IOS.\\

Bajo esta disyuntiva, los factores que nos llevaron a tomar la decisión de implementar una aplicación móvil Android fueron los siguientes:

\begin{itemize}
\item Como bien es sabido, la base de Android es Java. Java es uno de los lenguajes más universales y extendidos en el mundo del desarrollo, así que un grandísimo número de desarrolladores lo encontrarán más amigable. Esto, sumado a que desde 2008 me dedico profesionalmente al desarrollo de aplicaciones web con Java, fue un factor determinante a la hora tomar la decisión.
\item Android es un sistema más abierto y "libre" para el desarrollador, permitiéndole tener en una app un control mucho más amplio del terminal que en IOS.
\item La disponibilidad de las herramientas para desarrollar la aplicación también influyó en la decisión. Desarrollar una aplicación IOS requiere hacer uso de un ordenador Mac y de un iPhone para el testeo de la aplicación en el hardware real; herramientas que, teniendo en cuenta que necesitamos hacer uso de los sensores hardware del dispositivo, habría sido necesario adquirir para acometer el desarrollo.
\item Android copa actualmente el 92\% del mercado español \cite{website:cuota}, por lo que por estadística podría hacer uso de la aplicación un público más amplio.
\end{itemize}

Todos estos factores, sumados a la baja curva de aprendizaje necesaria debido principalmente a mi experiencia previa con Java, nos llevaron a seleccionar Android como plataforma de desarrollo.

\section{Entorno de construcción}

Una vez que se ha llegado a la conclusión anterior de implementar la aplicación móvil haciendo uso de Android, se procede a analizar el entorno de construcción que permitirá el desarrollo de todo el sistema.

\subsection{Android Studio}

Para el desarrollo de la aplicación haremos uso del entorno de desarrollo integrado (IDE) Android Studio \cite{website:androidstudio}. Android Studio es el entorno de desarrollo integrado oficial para el desarrollo de aplicaciones para Android y se basa en IntelliJ IDEA.\\

Entre las muchas ventajas que nos ofrece podemos contar con una vista ordenada y modular de los archivos que componen nuestro proyecto. La vista mostrada no se corresponde con la forma original de los archivos en disco, sino que está pensada para optimizar el trabajo.\\

Integrado en nuestro entorno de trabajo, podemos encontrar un sistema para el control de versiones, que incluye soporte para los repositorios más conocidos (Git, Subversion, etc). En nuestro caso se integró con Git, que es el software de control de versiones seleccionado para el presente proyecto, como ya se indicó anteriormente en el documento.\\

La interfaz gráfica está dividida de forma que se muestra una gran cantidad de información de forma eficiente. Además es totalmente personalizable, permitiendo al usuario mostrar y ocultar secciones según se requiera. Android Studio sigue el contexto de trabajo del usuario, mostrando las ventanas con las herramientas que considera oportunas en cada instante.\\

A continuación se muestra un ejemplo de interfaz gráfica:

\figura{androidstudio.png}{scale=0.34}{Interfaz de Android Studio}{androidstudio}{H}

\begin{enumerate}
\item Barra de herramientas: Permite realizar una amplia de gama de acciones: edición, búsqueda, iniciar aplicación, debug, etc. 
\item Barra de navegación: Permite navegar entre los archivos abiertos para facilitar su edición.
\item Ventana de edición: Permite modificar los diferentes archivos.
\item Ventana de herramientas: Proporciona acceso a la gestión del proyecto, control de versiones, consola, etc.
\item Barra de estado: Muestra el estado del proyecto, así como mensajes y avisos.
\end{enumerate}

Para finalizar nuestra visión de Android Studio, finalizaremos hablando de Gradle. Gradle es un sistema abierto que automatiza la compilación del código. Utiliza un grafo dirigido acíclico para determinar en qué orden se pueden ejecutar las tareas. Android Studio incorpora esta tecnología para facilitar la reutilización de código permitiendo generar APKs con distintas funcionalidades partiendo de un mismo proyecto.

\subsection{Android Software Development Kit}

Android SDK o Software Development Kit es un conjunto de herramientas para desarrollar, compilar y depurar aplicaciones para el sistema operativo Android, en definitiva, es una API que además de herramientas para el desarrollo, proporciona soporte técnico, ejemplos y una buena documentación.\\

El SDK incluye un emulador de dispositivos Android, lo que permite probar las aplicaciones de forma rápida y eficiente. Los parámetros de nuestro emulador pueden configurarse de forma que podemos elegir las características que tendrá nuestro dispositivo, como la memoria principal, el tamaño del dispositivo o la versión de Android, lo que permite al programador probar su código en una infinidad de dispositivos sin necesidad de adquirirlos.

\section{Código fuente}

El código fuente desarrollado de la aplicación está alojado en el repositorio GitHub:\\ 

\url{https://github.com/alvarogonzalezalvarez/SeniorFitness}\\

A continuación se muestra una lista con las diferentes clases Java implementadas durante la realización de la aplicación. Junto a cada una de las clases habrá una pequeña descripción sobre la labor que desempeña cada una.

\subsection{Activities}

Una Activity es un componente de la aplicación que contiene una pantalla con la que los usuarios pueden interactuar para realizar una acción. A cada actividad se le asigna una ventana en la que se pinta la interfaz de usuario asociada. A continuación se listan las activities que se han implementado:

\begin{itemize}
\item \textbf{AddUserActivity:} Activity que contiene la lógica de negocio referente a la pantalla de registro/alta de personas. 
\item \textbf{AgilidadActivity:} Activity que contiene la lógica de negocio referente a la pantalla del test Agilidad de la batería de pruebas Senior Fitness Test. Esta actividad extiende a ExerciseActivity.
\item \textbf{ExerciseActivity:} Activity que contiene toda la lógica de negocio común a todos los tests de la batería de pruebas Senior Fitness Test. Provee los métodos y funciones listas para su uso o sobreescritura por cada uno de los tests.
\item \textbf{FlexibilidadBrazosActivity:} Activity que contiene la lógica de negocio referente a la pantalla del test Flexibilidad de brazos de la batería de pruebas Senior Fitness Test. Esta actividad extiende a ExerciseActivity.
\item \textbf{FlexibilidadPiernasActivity:} Activity que contiene la lógica de negocio referente a la pantalla del test Flexibilidad de piernas de la batería de pruebas Senior Fitness Test. Esta actividad extiende a ExerciseActivity.
\item \textbf{FuerzaBrazosActivity:} Activity que contiene la lógica de negocio referente a la pantalla del test Fuerza de brazos de la batería de pruebas Senior Fitness Test. Esta actividad extiende a ExerciseActivity.
\item \textbf{FuerzaPiernasActivity:} Activity que contiene la lógica de negocio referente a la pantalla del test Fuerza de piernas de la batería de pruebas Senior Fitness Test. Esta actividad extiende a ExerciseActivity.
\item \textbf{InfoActivity:} Activity que contiene la lógica de negocio referente a la pantalla de información de los diferentes tests de la batería de pruebas Senior Fitness Test.
\item \textbf{MainActivity:} Activity que contiene la lógica de negocio referente a la pantalla principal de la aplicación. Esta actividad es la que se lanza por defecto cuando se abre la aplicación.
\item \textbf{ResistenciaAerobicaActivity:} Activity que contiene la lógica de negocio referente a la pantalla del test Resistencia aeróbica de la batería de pruebas Senior Fitness Test. Esta actividad extiende a ExerciseActivity.
\item \textbf{ResultsActivity:} Activity que contiene la lógica de negocio referente a la pantalla de resultados mostrada tras finalizar todos los tests de una sesión.
\item \textbf{SelectTestActivity:} Activity que contiene la lógica de negocio referente a la pantalla de selección de los diferentes tests que componen la batería de pruebas Senior Fitness Test.
\item \textbf{StartSessionActivity:} Activity que contiene la lógica de negocio referente a la pantalla de selección de la persona que comenzará la sesión de ejercicios.
\item \textbf{StatsActivity:} Activity que contiene la lógica de negocio referente a la pantalla de estadísticas de una sesión concreta ya completada por la persona para la cual se está visualizando el detalle.
\item \textbf{UserDetailsActivity:} Activity que contiene la lógica de negocio referente a la pantalla de detalle/historial de usuario.
\end{itemize}

\subsection{Listeners}

Los listeners o escuchadores son clases usadas para recibir notificaciones procedentes del SensorManager (clase que nos permite acceder a los sensores del dispositivo). A continuación listamos los listeners que se han implementado.

\begin{itemize}
\item \textbf{ExerciseListener:} Listener que implementa la clase SensorEventListener. Cada vez que hay un evento del sensor usado se invoca el método onSensorChanged, que será el método donde se harán los cálculos necesarios para detectar si el ejercicio se ha realizado de forma satisfactoria. Éste método debe ser implementado por los listeners que extienden de ExerciseListener.
\item \textbf{FuerzaBrazosListener:} Listener encargado de detectar y leer los movimientos realizados durante la realización del test Fuerza de brazos de la batería de pruebas Senior Fitness Test. Este listener extiende a ExerciseListener.
\item \textbf{FuerzaPiernasListener:} Listener encargado de detectar y leer los movimientos realizados durante la realización del test Fuerza de piernas de la batería de pruebas Senior Fitness Test. Este listener extiende a ExerciseListener.
\item \textbf{ResistenciaAerobicaListener:} Listener encargado de detectar y leer los movimientos realizados durante la realización del test Resistencia aeróbica de la batería de pruebas Senior Fitness Test. Este listener extiende a ExerciseListener.
\end{itemize}

\subsection{Base de Datos}

A continuación se listarán las clases encargadas de la definición, gestión y uso de la base de datos:

\begin{itemize}
\item \textbf{SeniorFitnessContract:} Clase java donde se definen las tablas usadas y los nombres y tipos de los campos de cada una de las mismas.
\item \textbf{SeniorFitnessDBHelper:} Clase java que extiende a SQLiteOpenHelper. Se encarga de gestionar la creación y manipulación de la base de datos, así como del versionado de la misma.
\end{itemize}

\subsection{Modelo}

Se listarán a continuación las clases Java que representan el modelo de la aplicación:

\begin{itemize}
\item \textbf{Result:} Clase java que representa los resultados obtenidos, asociado a un test, a una sesión y a una persona.
\item \textbf{Session:} Clase java que representa a las sesiones de tests que realizan las personas dadas de alta en la aplicación.
\item \textbf{Test:} Clase java que representa a los diferentes tests que componen la batería de pruebas Senior Fitness Test.
\item \textbf{User:} Clase java que representa a las personas dadas de alta en la aplicación.
\end{itemize}

\subsection{Adapters}

Un adapter es un objeto que funciona como puente entre un AdapterView y los correspondientes datos para esa vista, proporcionando acceso a los datos del elemento. También es el encargado de construir una vista (View) por cada elemento del conjunto de datos. A continuación listamos los adapters implementados para la aplicación:

\begin{itemize}
\item \textbf{SessionsAdapter:} Adapter utilizado para convertir en una View independiente cada elemento contenido en el listado de sesiones recuperadas para una persona concreta y mostradas en la pantalla de detalle de persona.
\item \textbf{TestsAdapter:} Adapter utilizado para convertir en una View independiente cada elemento contenido en el listado de tests mostrados en la pantalla de selección de test.
\item \textbf{UsersAdapter:} Adapter utilizado para convertir en una View independiente cada elemento contenido en el listado de personas dadas de alta en la aplicación, y que se muestran en la pantalla principal y en la pantalla de selección de persona.
\end{itemize}

\section{Detección de movimiento}

Una de las características principales de la aplicación es la capacidad de leer y detectar los movimientos realizados durante la realización de determinados tests. A continuación entraremos en los detalles sobre cómo se ha implementado el cálculo y la lectura de los parámetros necesarios para determinar si las repeticiones del ejercicio se han realizado de forma satisfactoria o no, para lo cual se ha hecho uso del sensor de gravedad.\\

\subsection{Sensor de gravedad}

El sensor de gravedad mide el efecto de la aceleración de la gravedad de la tierra sobre el dispositivo. No se trata de un sensor hardware, sino que es un sensor software o virtual derivado del acelerómetro, donde otros sensores hardware como el giroscopio ayudan a eliminar la aceleración lineal de los datos. La gravedad se mide en $m/s^{2}$ como el caso del acelerómetro, y se mide sobre los ejes X, Y y Z.\\

Supongamos que tenemos el dispositivo móvil colocado sobre una mesa, tumbado sobre su parte trasera y de forma totalmente paralela al suelo y con la pantalla mirando hacia el techo; en este caso la gravedad estaría ejerciendo una aceleración de 9,8 $m/s^{2}$ sobre la pantalla del dispositivo de forma perpendicular a la misma, o lo que es lo mismo, estaría ejerciendo una aceleración de 9,8 $m/s^{2}$ sobre el eje Z tal y como podemos observar en el siguiente gráfico:

\figura{gravedadz.png}{scale=0.2}{Efecto de la gravedad sobre el eje Z con el dispositivo colocado de forma paralela sobre el suelo y con la pantalla hacia arriba}{gravedadz}{H}

Partiendo de este gráfico podemos definir cada eje como sigue:

\begin{itemize}
\item \textbf{Eje Z:} Es la línea que atraviesa el dispositivo móvil de forma perpendicular a su pantalla.
\item \textbf{Eje Y:} Es la línea paralela a la pantalla que atraviesa el dispositivo desde su parte superior hasta la inferior o viceversa.
\item \textbf{Eje X:} Es la línea paralela a la pantalla que atraviesa el dispositivo desde su lado izquierdo hasta el derecho o viceversa.
\end{itemize}

Por lo que, teniendo en cuenta la situación de los ejes respecto al dispositivo, podríamos decir entonces que si sostenemos el móvil de forma perpendicular al suelo, como por ejemplo en el supuesto de que estuviésemos de pie realizando una llamada telefónica y tuviésemos el altavoz sobre la oreja, la gravedad estaría ejerciendo sobre el eje Y del dispositivo (es decir, atravesándolo desde la parte superior hasta la inferior), por lo que el gráfico mientras sujetamos el dispositivo de la forma comentada sería el siguiente:

\figura{gravedady.png}{scale=0.2}{Efecto de la gravedad sobre el eje Y con el dispositivo colocado de forma perpendicular (de pie) sobre el suelo}{gravedady}{H}

Una vez hemos entendido como se mide la gravedad sobre cada uno de los ejes del dispositivo móvil, podemos hacer uso de las medidas obtenidas sobre cada eje para determinar la posición en la que se encuentra el móvil conforme se va realizando el movimiento de cada ejercicio.

\subsection{Lectura para el test Fuerza de brazos}

Teniendo en cuenta que el dispositivo móvil debe colocarse sobre el antebrazo tal y como se ilustró en la figura \ref{dispositivo_movil_brazos}, sabremos que la aceleración ejercida sobre el dispositivo en la posición inicial del ejercicio será negativa sobre el eje Y (dado que la persona tendrá el brazo totalmente extendido con el puño hacia abajo, quedando el dispositivo bocabajo) tal y como puede observarse en el estado de la siguiente gráfica mientras el dispositivo se encuentra en la posición comentada:

\figura{gravedady_brazos_inicial.png}{scale=0.15}{Fuerza de brazos: Efecto de la gravedad sobre el eje Y en la posición inicial}{gravedady_brazos_inicial}{H}

Por tanto, en la posición final del ejercicio (cuando el brazo queda flexionado con el puño hacia arriba) la gravedad ejercida sobre el eje Y será positiva:

\figura{gravedady_brazos_final.png}{scale=0.15}{Fuerza de brazos: Efecto de la gravedad sobre el eje Y en la posición final}{gravedady_brazos_final}{H}

De esta forma, sabremos que la repetición se ha completado de forma satisfactoria cuando la gravedad ejercida en el eje Y pasa de ser negativa, a ser positiva y mayor que 7,5 $m/s^{2}$ (para asegurarnos de que se ha flexionado el brazo lo suficiente) en la posición final.

\subsection{Lectura para el test Fuerza de piernas}

Teniendo en cuenta que el dispositivo móvil debe colocarse sobre la pierna tal y como se ilustró en la figura \ref{dispositivo_movil_piernas}, sabremos que la aceleración ejercida sobre el dispositivo en la posición inicial del ejercicio será normalmente cercana a 0 $m/s^{2}$ (dos unidades arriba o abajo) sobre el eje Y (dado que el punto de partida del ejercicio es estando sentado, y por tanto el dispositivo móvil queda prácticamente paralelo al suelo) tal y como puede observarse en el estado de la siguiente gráfica mientras el dispositivo se encuentra en la posición comentada:

\figura{gravedady_piernas_inicial.png}{scale=0.15}{Fuerza de piernas: Efecto de la gravedad sobre el eje Y en la posición inicial}{gravedady_piernas_inicial}{H}

Sin embargo, en la posición final del ejercicio, al estar de pie la persona y por tanto quedar el dispositivo móvil bocabajo y perpendicular sobre el suelo, la gravedad ejercida sobre el eje Y será negativa y se acercará a los -9,8 $m/s^{2}$, tal y como se puede ver en la siguiente gráfica:

\figura{gravedady_piernas_final.png}{scale=0.15}{Fuerza de piernas: Efecto de la gravedad sobre el eje Y en la posición final}{gravedady_piernas_final}{H}

Así, sabremos que la repetición se ha completado de forma satisfactoria cuando la gravedad ejercida en el eje Y pasa de estar rondando el 0, a ser negativa y menor que -8,5 $m/s^{2}$ en la posición final.

\subsection{Lectura para el test Resistencia aeróbica}

La lectura para este caso es exactamente la misma que para el test de Fuerza de piernas, pero de forma inversa; en este ejercicio la posición inicial será estando la persona de pie con el dispositivo móvil colocado en la pierna tal y como se ilustra en la figura \ref{dispositivo_movil_piernas}, por lo que en este caso la gráfica sería la siguiente en la posición inicial:

\figura{gravedady_resistencia_inicial.png}{scale=0.15}{Resistencia aeróbica: Efecto de la gravedad sobre el eje Y en la posición inicial}{gravedady_resistencia_inicial}{H}

Por tanto, para la posición final, al quedar la pierna flexionada con la rodilla levantada hasta una altura equivalente al punto medio entre la rótula y la cresta ilíaca, el dispositivo móvil quedará prácticamente paralelo al suelo, por lo que la gravedad ejercida sobre el eje Y estará rondando el 0, tal y como se puede observar a continuación:

\figura{gravedady_resistencia_final.png}{scale=0.15}{Resistencia aeróbica: Efecto de la gravedad sobre el eje Y en la posición final}{gravedady_resistencia_final}{H}

De esta forma, sabremos que la repetición se ha completado de forma satisfactoria cuando la gravedad ejercida en el eje Y pasa de ser negativa y menor a -8,5 $m/s^{2}$ , a ser mayor que -4,5 $m/s^{2}$ en la posición final (para asegurarnos de que se ha levantado la rodilla lo suficiente).
